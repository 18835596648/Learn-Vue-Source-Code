<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. 前言 | 逐行剖析 Vue.js 源码</title>
    <meta name="description" content="">
    <link rel="icon" href="/Learn-Vue-Source-Code/logo.png">
  <link rel="manifest" href="/Learn-Vue-Source-Code/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/Learn-Vue-Source-Code/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/Learn-Vue-Source-Code/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/Learn-Vue-Source-Code/assets/css/0.styles.c9a001c8.css" as="style"><link rel="preload" href="/Learn-Vue-Source-Code/assets/js/app.f0cad1ff.js" as="script"><link rel="preload" href="/Learn-Vue-Source-Code/assets/js/2.9c97d897.js" as="script"><link rel="preload" href="/Learn-Vue-Source-Code/assets/js/21.9db0a597.js" as="script"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/10.fe6b8229.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/11.93edba8d.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/12.a65854eb.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/13.6cd97566.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/14.dd18156e.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/15.265229d1.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/16.31505f82.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/17.6ffa0b86.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/18.f702fcca.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/19.15a96c16.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/20.c7dcd9be.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/22.6cb56720.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/23.b1cfbe84.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/24.711e1b61.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/25.6972e93d.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/26.bda6ad7a.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/3.2b73f344.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/4.693c568d.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/5.d3fa9609.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/6.72475644.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/7.f51b3674.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/8.98762ea7.js"><link rel="prefetch" href="/Learn-Vue-Source-Code/assets/js/9.1a2c0347.js">
    <link rel="stylesheet" href="/Learn-Vue-Source-Code/assets/css/0.styles.c9a001c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Learn-Vue-Source-Code/" class="home-link router-link-active"><!----> <span class="site-name">逐行剖析 Vue.js 源码</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/NLRX-WJC/Learn-Vue-Source-Code" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/NLRX-WJC/Learn-Vue-Source-Code" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>写在最前面</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learn-Vue-Source-Code/start/" class="sidebar-link">写在最前面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>变化侦测</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learn-Vue-Source-Code/reactive/" class="sidebar-link">综述</a></li><li><a href="/Learn-Vue-Source-Code/reactive/object.html" class="sidebar-link">Object的变化侦测</a></li><li><a href="/Learn-Vue-Source-Code/reactive/array.html" class="sidebar-link">Array的变化侦测</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>虚拟DOM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learn-Vue-Source-Code/virtualDOM/" class="sidebar-link">Vue中的虚拟DOM</a></li><li><a href="/Learn-Vue-Source-Code/virtualDOM/patch.html" class="sidebar-link">Vue中的DOM-Diff</a></li><li><a href="/Learn-Vue-Source-Code/virtualDOM/updataChildren.html" class="sidebar-link">更新子节点</a></li><li><a href="/Learn-Vue-Source-Code/virtualDOM/optimizeUpdataChildren.html" class="sidebar-link">优化更新子节点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模板编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learn-Vue-Source-Code/complie/" class="sidebar-link">综述</a></li><li><a href="/Learn-Vue-Source-Code/complie/parse.html" class="sidebar-link">模板解析阶段(整体运行流程)</a></li><li><a href="/Learn-Vue-Source-Code/complie/HTMLParse.html" class="sidebar-link">模板解析阶段(HTML解析器)</a></li><li><a href="/Learn-Vue-Source-Code/complie/textParse.html" class="sidebar-link">模板解析阶段(文本解析器)</a></li><li><a href="/Learn-Vue-Source-Code/complie/optimize.html" class="sidebar-link">优化阶段</a></li><li><a href="/Learn-Vue-Source-Code/complie/codegen.html" class="sidebar-link">代码生成阶段</a></li><li><a href="/Learn-Vue-Source-Code/complie/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>生命周期</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Learn-Vue-Source-Code/lifecycle/" class="sidebar-link">综述</a></li><li><a href="/Learn-Vue-Source-Code/lifecycle/newVue.html" class="sidebar-link">初始化阶段(new Vue)</a></li><li><a href="/Learn-Vue-Source-Code/lifecycle/initLifecycle.html" class="sidebar-link">初始化阶段(initLifecycle)</a></li><li><a href="/Learn-Vue-Source-Code/lifecycle/initEvents.html" class="active sidebar-link">初始化阶段(initEvents)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Learn-Vue-Source-Code/lifecycle/initEvents.html#_1-前言" class="sidebar-link">1. 前言</a></li><li class="sidebar-sub-header"><a href="/Learn-Vue-Source-Code/lifecycle/initEvents.html#_2-解析事件" class="sidebar-link">2. 解析事件</a></li><li class="sidebar-sub-header"><a href="/Learn-Vue-Source-Code/lifecycle/initEvents.html#_3-initevents函数分析" class="sidebar-link">3.   initEvents函数分析</a></li><li class="sidebar-sub-header"><a href="/Learn-Vue-Source-Code/lifecycle/initEvents.html#_4-总结" class="sidebar-link">4. 总结</a></li></ul></li><li><a href="/Learn-Vue-Source-Code/lifecycle/initInjections.html" class="sidebar-link">初始化阶段(initInjections)</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h2> <p>本篇文章介绍生命周期初始化阶段所调用的第二个初始化函数——<code>initEvents</code>。从函数名字上来看，这个初始化函数是初始化实例的事件系统。我们知道，在<code>Vue</code>中，当我们在父组件中使用子组件时可以给子组件上注册一些事件，这些事件即包括使用<code>v-on</code>或<code>@</code>注册的自定义事件，也包括注册的浏览器原生事件（需要加 <code>.native</code> 修饰符），如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child</span> <span class="token attr-name">@select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>selectHandler<span class="token punctuation">&quot;</span></span> 	<span class="token attr-name">@click.native</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>clickHandler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>不管是什么事件，当子组件（即实例）在初始化的时候都需要进行一定的初始化，那么本篇文章就来看看实例上的事件都是如何进行初始化的。</p> <h2 id="_2-解析事件"><a href="#_2-解析事件" class="header-anchor">#</a> 2. 解析事件</h2> <p>我们先从解析事件开始说起，回顾之前的模板编译解析中，当遇到开始标签的时候，除了会解析开始标签，还会调用<code>processAttrs</code> 方法解析标签中的属性，<code>processAttrs</code> 方法位于源码的 <code>src/compiler/parser/index.js</code>中， 如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> onRE <span class="token operator">=</span> <span class="token regex">/^@|^v-on:/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> dirRE <span class="token operator">=</span> <span class="token regex">/^v-|^@|^:/</span>

<span class="token keyword">function</span> <span class="token function">processAttrs</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> list <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsList
  <span class="token keyword">let</span> i<span class="token punctuation">,</span> l<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name  <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name
    value <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解析修饰符</span>
      modifiers <span class="token operator">=</span> <span class="token function">parseModifiers</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>modifierRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// v-on</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>onRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> warn<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从上述代码中可以看到，在对标签属性进行解析时，判断如果属性是指令，首先通过 <code>parseModifiers</code> 解析出属性的修饰符，然后判断如果是事件的指令，则执行 <code>addHandler(el, name, value, modifiers, false, warn)</code> 方法，  该方法定义在 <code>src/compiler/helpers.js</code> 中，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addHandler</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>name<span class="token punctuation">,</span>value<span class="token punctuation">,</span>modifiers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modifiers <span class="token operator">=</span> modifiers <span class="token operator">||</span> emptyObject
  
    <span class="token comment">// check capture modifier 判断是否有capture修饰符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>capture
      name <span class="token operator">=</span> <span class="token string">'!'</span> <span class="token operator">+</span> name <span class="token comment">// 给事件名前加'!'用以标记capture修饰符</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否有once修饰符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>once
      name <span class="token operator">=</span> <span class="token string">'~'</span> <span class="token operator">+</span> name <span class="token comment">// 给事件名前加'~'用以标记once修饰符</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否有passive修饰符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>passive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>passive
      name <span class="token operator">=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> name <span class="token comment">// 给事件名前加'&amp;'用以标记passive修饰符</span>
    <span class="token punctuation">}</span>
  
  
    <span class="token keyword">let</span> events
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>native<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>native
      events <span class="token operator">=</span> el<span class="token punctuation">.</span>nativeEvents <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      events <span class="token operator">=</span> el<span class="token punctuation">.</span>events <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">const</span> newHandler<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers <span class="token operator">!==</span> emptyObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newHandler<span class="token punctuation">.</span>modifiers <span class="token operator">=</span> modifiers
      <span class="token punctuation">}</span>
    
      <span class="token keyword">const</span> handlers <span class="token operator">=</span> events<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newHandler<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        events<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>handlers<span class="token punctuation">,</span> newHandler<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        events<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> newHandler
      <span class="token punctuation">}</span>
    
      el<span class="token punctuation">.</span>plain <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>在<code>addHandler</code> 函数里做了 3 件事情，首先根据 <code>modifier</code> 修饰符对事件名 <code>name</code> 做处理，接着根据 <code>modifier.native</code> 判断事件是一个浏览器原生事件还是自定义事件，分别对应 <code>el.nativeEvents</code> 和 <code>el.events</code>，最后按照 <code>name</code> 对事件做归类，并把回调函数的字符串保留到对应的事件中。</p> <p>在前言中的例子中，父组件的 <code>child</code> 节点生成的 <code>el.events</code> 和 <code>el.nativeEvents</code> 如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>el<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span>
  select<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token string">'selectHandler'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

el<span class="token punctuation">.</span>nativeEvents <span class="token operator">=</span> <span class="token punctuation">{</span>
  click<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token string">'clickHandler'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后在模板编译的代码生成阶段，会在 <code>genData</code> 函数中根据 <code>AST</code> 元素节点上的 <code>events</code> 和 <code>nativeEvents</code> 生成<code>_c(tagName,data,children)</code>函数中所需要的 <code>data</code> 数据，它的定义在 <code>src/compiler/codegen/index.js</code> 中：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter">el state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">'{'</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>state<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>生成的<code>data</code>数据如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  	<span class="token comment">// ...</span>
    on<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;select&quot;</span><span class="token punctuation">:</span> selectHandler<span class="token punctuation">}</span><span class="token punctuation">,</span>
  	nativeOn<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token keyword">return</span> <span class="token function">clickHandler</span><span class="token punctuation">(</span>$event<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到，最开始的模板中标签上注册的事件最终会被解析成用于创建元素型<code>VNode</code>的<code>_c(tagName,data,children)</code>函数中<code>data</code>数据中的两个对象，自定义事件对象<code>on</code>，浏览器原生事件<code>nativeOn</code>。</p> <p>在前面的文章中我们说过，模板编译的最终目的是创建<code>render</code>函数供挂载的时候调用生成虚拟<code>DOM</code>，那么在挂载阶段， 如果被挂载的节点是一个组件节点，则通过 <code>createComponent</code> 函数创建一个组件 <code>vnode</code>，该函数位于源码的 <code>src/core/vdom/create-component.js</code> 中， 如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span>
  <span class="token parameter">Ctor<span class="token punctuation">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> Function <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token operator">?</span>VNodeData<span class="token punctuation">,</span>
  context<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token punctuation">:</span> string</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> VNode <span class="token operator">|</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> data<span class="token punctuation">.</span>on
  
  data<span class="token punctuation">.</span>on <span class="token operator">=</span> data<span class="token punctuation">.</span>nativeOn
  
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> Ctor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name <span class="token operator">||</span> tag
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-component-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Ctor<span class="token punctuation">.</span>cid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> Ctor<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">,</span>
    asyncFactory
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>可以看到，把 自定义事件<code>data.on</code> 赋值给了 <code>listeners</code>，把浏览器原生事件 <code>data.nativeOn</code> 赋值给了 <code>data.on</code>，这说明所有的原生浏览器事件处理是在当前父组件环境中处理的。而对于自定义事件，会把 <code>listeners</code> 作为 <code>vnode</code> 的 <code>componentOptions</code> 传入，放在子组件初始化阶段中处理， 在子组件的初始化的时候，  拿到了父组件传入的 <code>listeners</code>，然后在执行 <code>initEvents</code> 的过程中，会处理这个 <code>listeners</code>。</p> <p>所以铺垫了这么多，结论来了：<strong>父组件给子组件的注册事件中，把自定义事件传给子组件，在子组件实例化的时候进行初始化；而浏览器原生事件是在父组件中处理。</strong></p> <p>换句话说：<strong>实例初始化阶段调用的初始化事件函数<code>initEvents</code>实际上初始化的是父组件在模板中使用v-on或@注册的监听子组件内触发的事件。</strong></p> <h2 id="_3-initevents函数分析"><a href="#_3-initevents函数分析" class="header-anchor">#</a> 3.   initEvents函数分析</h2> <p>了解了以上过程之后，我们终于进入了正题，开始分析<code>initEvents</code>函数，该函数位于源码的<code>src/instance/events.js</code>中，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initEvents</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// init parent attached events</span>
  <span class="token keyword">const</span> listeners <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentListeners
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到，<code>initEvents</code>函数逻辑非常简单，首先在<code>vm</code>上新增<code>_events</code>属性并将其赋值为空对象，用来存储事件。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接着，获取父组件注册的事件赋给<code>listeners</code>，如果<code>listeners</code>不为空，则调用<code>updateComponentListeners</code>函数，将父组件向子组件注册的事件注册到子组件的实例中，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> listeners <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentListeners
<span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个<code>updateComponentListeners</code>函数是什么呢？该函数定义如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateComponentListeners</span> <span class="token punctuation">(</span>
  <span class="token parameter">vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>
  listeners<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  oldListeners<span class="token punctuation">:</span> <span class="token operator">?</span>Object</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target <span class="token operator">=</span> vm
  <span class="token function">updateListeners</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> oldListeners <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> add<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  target <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> once</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到，<code>updateComponentListeners</code>函数其实也没有干什么，只是调用了<code>updateListeners</code>函数，并把<code>listeners</code>以及<code>add</code>和<code>remove</code>这两个函数传入。我们继续跟进，看看<code>updateListeners</code>函数干了些什么，<code>updateListeners</code>函数位于源码的<code>src/vdom/helpers/update-listeners.js</code>中，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateListeners</span> <span class="token punctuation">(</span>
  <span class="token parameter">on<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  oldOn<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  add<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  remove<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  vm<span class="token punctuation">:</span> Component</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> name<span class="token punctuation">,</span> def<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> old<span class="token punctuation">,</span> event
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token operator">=</span> cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    old <span class="token operator">=</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid handler for event &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: got </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> event<span class="token punctuation">.</span>once<span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">,</span> event<span class="token punctuation">.</span>passive<span class="token punctuation">,</span> event<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> old<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      old<span class="token punctuation">.</span>fns <span class="token operator">=</span> cur
      on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> old
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>可以看到，该函数的作用是对比<code>listeners</code>和<code>oldListeners</code>的不同，并调用参数中提供的<code>add</code>和<code>remove</code>进行相应的注册事件和卸载事件。其思想是：如果<code>listeners</code>对象中存在某个<code>key</code>（即事件名）而<code>oldListeners</code>中不存在，则说明这个事件是需要新增的；反之，如果<code>oldListeners</code>对象中存在某个<code>key</code>（即事件名）而<code>listeners</code>中不存在，则说明这个事件是需要从事件系统中卸载的；</p> <p>该函数接收5个参数，分别时<code>on</code>、<code>oldOn</code>、<code>add</code>、<code>remove</code>、<code>vm</code>，其中<code>on</code>对应<code>listeners</code>，<code>oldOn</code>对应<code>oldListeners</code>。</p> <p>首先对<code>on</code>进行遍历， 获得每一个事件名，然后调用 <code>normalizeEvent</code> 函数（关于该函数下面会介绍）处理， 处理完事件名后， 判断事件名对应的值是否存在，如果不存在则抛出警告，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token operator">=</span> cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    old <span class="token operator">=</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid handler for event &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: got </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果存在，则继续判断该事件名在<code>oldOn</code>中是否存在，如果不存在，则调用<code>add</code>注册事件，如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> event<span class="token punctuation">.</span>once<span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">,</span> event<span class="token punctuation">.</span>passive<span class="token punctuation">,</span> event<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里定义了 <code>createFnInvoker</code> 方法并返回<code>invoker</code>函数:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFnInvoker</span> <span class="token punctuation">(</span><span class="token parameter">fns</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">invoker</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fns <span class="token operator">=</span> invoker<span class="token punctuation">.</span>fns
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> cloned <span class="token operator">=</span> fns<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cloned<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cloned<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// return handler return value for single handlers</span>
      <span class="token keyword">return</span> <span class="token function">fns</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  invoker<span class="token punctuation">.</span>fns <span class="token operator">=</span> fns
  <span class="token keyword">return</span> invoker
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>由于一个事件可能会对应多个回调函数，所以这里做了数组的判断，多个回调函数就依次调用。注意最后的赋值逻辑， <code>invoker.fns = fns</code>，每一次执行 <code>invoker</code> 函数都是从 <code>invoker.fns</code> 里取执行的回调函数，回到 <code>updateListeners</code>，当我们第二次执行该函数的时候，判断如果 <code>cur !== old</code>，那么只需要更改 <code>old.fns = cur</code> 把之前绑定的 <code>involer.fns</code> 赋值为新的回调函数即可，并且 通过 <code>on[name] = old</code> 保留引用关系，这样就保证了事件回调只添加一次，之后仅仅去修改它的回调函数的引用。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> old<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    old<span class="token punctuation">.</span>fns <span class="token operator">=</span> cur
    on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> old
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后遍历 <code>oldOn</code>， 获得每一个事件名，判断如果事件名在<code>on</code>中不存在，则表示该事件是需要从事件系统中卸载的事件，则调用 <code>remove</code>方法卸载该事件。</p> <p>以上就是<code>updateListeners</code>函数的所有逻辑，那么上面还遗留了一个<code>normalizeEvent</code> 函数是干什么用的呢？还记得我们在解析事件的时候，当事件上有修饰符的时候，我们会根据不同的修饰符给事件名前面添加不同的符号以作标识，其实这个<code>normalizeEvent</code> 函数就是个反向操作，根据事件名前面的不同标识反向解析出该事件所带的何种修饰符，其代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> normalizeEvent <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  once<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>
  capture<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>
  passive<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>
  handler<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  params<span class="token operator">?</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> passive <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'&amp;'</span>
  name <span class="token operator">=</span> passive <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> name
  <span class="token keyword">const</span> once <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'~'</span>
  name <span class="token operator">=</span> once <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> name
  <span class="token keyword">const</span> capture <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'!'</span>
  name <span class="token operator">=</span> capture <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> name
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">,</span>
    once<span class="token punctuation">,</span>
    capture<span class="token punctuation">,</span>
    passive
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到，就是判断事件名的第一个字符是何种标识进而判断出事件带有何种修饰符，最终将真实事件名及所带的修饰符返回。</p> <h2 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4. 总结</h2> <p>本篇文章介绍了生命周期初始化阶段所调用的第二个初始化函数——<code>initEvents</code>。该函数是用来初始化实例的事件系统的。</p> <p>我们先从模板编译时对组件标签上的事件解析入手分析，我们知道了，父组件既可以给子组件上绑定自定义事件，也可以绑定浏览器原生事件。这两种事件有着不同的处理时机，浏览器原生事件是由父组件处理，而自定义事件是在子组件初始化的时候由父组件传给子组件，再由子组件注册到实例的事件系统中。</p> <p>也就是说：<strong>初始化事件函数initEvents实际上初始化的是父组件在模板中使用v-on或@注册的监听子组件内触发的事件。</strong></p> <p>最后分析了<code>initEvents</code>函数的具体实现过程，该函数内部首先在实例上新增了<code>_events</code>属性并将其赋值为空对象，用来存储事件。接着通过调用<code>updateComponentListeners</code>函数，将父组件向子组件注册的事件注册到子组件实例中的<code>_events</code>对象里。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NLRX-WJC/Learn-Vue-Source-Code/edit/master/docs/lifecycle/initEvents.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/29/2019, 3:36:09 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Learn-Vue-Source-Code/lifecycle/initLifecycle.html" class="prev">初始化阶段(initLifecycle)</a></span> <span class="next"><a href="/Learn-Vue-Source-Code/lifecycle/initInjections.html">初始化阶段(initInjections)</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Learn-Vue-Source-Code/assets/js/app.f0cad1ff.js" defer></script><script src="/Learn-Vue-Source-Code/assets/js/2.9c97d897.js" defer></script><script src="/Learn-Vue-Source-Code/assets/js/21.9db0a597.js" defer></script>
  </body>
</html>
